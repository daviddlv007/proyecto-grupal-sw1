name: 🚀 Auto Deploy API 

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'docker-compose.caddy.yml'
      - 'infra/caddy/**'
      - '.github/workflows/**'
  
  workflow_dispatch:

jobs:
  deploy:
    name: 🌐 Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
    - name: 📂 Checkout code
      uses: actions/checkout@v4
      
    - name: 🚀 Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          set -e
          echo "🔄 Starting deployment..."
          
          cd /root/proyecto-grupal-sw1
          
          echo "📥 Pulling latest code..."
          git pull origin main
          
          echo "⏹️ Stopping current containers..."
          docker compose -f docker-compose.caddy.yml down || true
          
          echo "🧹 Cleaning up..."
          docker system prune -f || true
          
          export DOMAIN=softwaredlv.duckdns.org
          
          echo "🏗️ Building and starting containers..."
          docker compose -f docker-compose.caddy.yml up -d --build
          
          echo "🔍 Checking deployment..."
          sleep 15
          
          if docker compose -f docker-compose.caddy.yml ps | grep -q "Up"; then
            echo "✅ Containers running!"
            if curl -f -s https://softwaredlv.duckdns.org/health > /dev/null; then
              echo "✅ API responding!"
            else
              echo "⚠️ API might be starting..."
            fi
            echo "🎉 Deployment completed!"
          else
            echo "❌ Deployment failed"
            docker compose -f docker-compose.caddy.yml logs --tail=20
            exit 1
          fi
          
    - name: 📊 Summary
      run: |
        echo "## 🚀 Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "✅ **API deployed successfully**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Links:**" >> $GITHUB_STEP_SUMMARY
        echo "- [📚 API Docs](https://softwaredlv.duckdns.org/docs)" >> $GITHUB_STEP_SUMMARY
        echo "- [🩺 Health](https://softwaredlv.duckdns.org/health)" >> $GITHUB_STEP_SUMMARY