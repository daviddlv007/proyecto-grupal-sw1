name: ðŸš€ Auto Deploy API 

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'docker-compose.caddy.yml'
      - 'infra/caddy/**'
      - '.github/workflows/**'
  
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸŒ Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“‚ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          set -e
          echo "ðŸ”„ Starting deployment..."
          
          cd /root/proyecto-grupal-sw1
          
          echo "ðŸ“¥ Pulling latest code..."
          git pull origin main
          
          echo "â¹ï¸ Stopping current containers..."
          docker compose -f docker-compose.caddy.yml down || true
          
          echo "ðŸ§¹ Cleaning up..."
          docker system prune -f || true
          
          export DOMAIN=softwaredlv.duckdns.org
          
          echo "ðŸ—ï¸ Building and starting containers..."
          docker compose -f docker-compose.caddy.yml up -d --build
          
          echo "ðŸ” Checking deployment..."
          sleep 15
          
          if docker compose -f docker-compose.caddy.yml ps | grep -q "Up"; then
            echo "âœ… Containers running!"
            if curl -f -s https://softwaredlv.duckdns.org/health > /dev/null; then
              echo "âœ… API responding!"
            else
              echo "âš ï¸ API might be starting..."
            fi
            echo "ðŸŽ‰ Deployment completed!"
          else
            echo "âŒ Deployment failed"
            docker compose -f docker-compose.caddy.yml logs --tail=20
            exit 1
          fi
          
    - name: ðŸ“Š Summary
      run: |
        echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **API deployed successfully**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Links:**" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“š API Docs](https://softwaredlv.duckdns.org/docs)" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ©º Health](https://softwaredlv.duckdns.org/health)" >> $GITHUB_STEP_SUMMARY