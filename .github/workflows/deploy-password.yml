name: 🚀 Auto Deploy API (Password Auth)

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'docker-compose.caddy.yml'
      - 'infra/caddy/**'
      - '.github/workflows/**'
  
  workflow_dispatch:

jobs:
  deploy:
    name: 🌐 Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
    - name: 📂 Checkout code
      uses: actions/checkout@v4
      
    - name: 🚀 Deploy via SSH with Password
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          set -e
          echo "🔄 Starting deployment..."
          
          # Ir al directorio del proyecto
          cd /root/proyecto-grupal-sw1
          
          # Actualizar código
          echo "📥 Pulling latest code..."
          git pull origin main
          
          # Detener contenedores actuales
          echo "⏹️ Stopping current containers..."
          docker compose -f docker-compose.caddy.yml down || true
          
          # Limpiar imágenes antiguas
          echo "🧹 Cleaning up old images..."
          docker system prune -f || true
          
          # Configurar variables de entorno
          export DOMAIN=softwaredlv.duckdns.org
          
          # Construir y ejecutar
          echo "🏗️ Building and starting containers..."
          docker compose -f docker-compose.caddy.yml up -d --build
          
          # Verificar deployment
          echo "🔍 Checking deployment..."
          sleep 15
          
          # Verificar contenedores
          if docker compose -f docker-compose.caddy.yml ps | grep -q "Up"; then
            echo "✅ Containers are running!"
            
            # Verificar API
            if curl -f -s https://softwaredlv.duckdns.org/health > /dev/null; then
              echo "✅ API is responding!"
            else
              echo "⚠️ API check failed, but containers are up"
            fi
          else
            echo "❌ Deployment failed"
            docker compose -f docker-compose.caddy.yml logs --tail=50
            exit 1
          fi
          
          echo "🎉 Deployment completed!"
          
    - name: 📊 Post-deployment verification
      run: |
        echo "## 🚀 Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "✅ **Deployment completed successfully**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔗 Links:" >> $GITHUB_STEP_SUMMARY
        echo "- [API Documentation](https://softwaredlv.duckdns.org/docs)" >> $GITHUB_STEP_SUMMARY
        echo "- [Health Check](https://softwaredlv.duckdns.org/health)" >> $GITHUB_STEP_SUMMARY
        echo "- [API Base](https://softwaredlv.duckdns.org)" >> $GITHUB_STEP_SUMMARY